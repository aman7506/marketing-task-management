<div class="modal fade" [class.show]="show" [style.display]="show ? 'block' : 'none'" tabindex="-1" role="dialog"
  [attr.aria-hidden]="!show">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i [class]="getModalIcon()"></i>
          {{ getModalTitle() }}
        </h5>
        <button type="button" class="btn-close" (click)="onClose()" aria-label="Close"
          [disabled]="isSubmitting || isDeleting">
        </button>
      </div>

      <form [formGroup]="taskForm" (ngSubmit)="onSubmit()" novalidate>
        <div class="modal-body">
          <!-- Basic Information Card -->
          <div class="card">
            <div class="card-header">
              <h6 class="card-title mb-0">
                <i class="bi bi-info-circle me-2"></i>
                Basic Information
              </h6>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-md-12">
                  <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                  <textarea id="description" class="form-control" rows="3" formControlName="description"
                    [readonly]="mode === 'view'" [class.is-invalid]="description?.invalid && description?.touched"
                    placeholder="Enter task description">
                  </textarea>
                  <div class="form-text">
                    <span *ngIf="description?.invalid && description?.touched" class="text-danger">
                      {{ description?.errors?.['required'] ? 'Description is required.' : 'Description must be at least
                      5 characters long.' }}
                    </span>
                    <span class="text-muted">{{ description?.value?.length || 0 }}/500</span>
                  </div>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="employeeName" class="form-label">Assigned Employee <span
                      class="text-danger">*</span></label>
                  <input type="text" id="employeeName" class="form-control" formControlName="employeeName"
                    placeholder="Enter employee name"
                    [class.is-invalid]="employeeName?.invalid && employeeName?.touched">
                  <div *ngIf="employeeName?.invalid && employeeName?.touched" class="invalid-feedback">
                    <div *ngIf="employeeName?.errors?.['required']">Employee name is required.</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <label for="priority" class="form-label">Priority <span class="text-danger">*</span></label>
                  <select id="priority" class="form-select" formControlName="priority"
                    [class.is-invalid]="priority?.invalid && priority?.touched">
                    <option value="">Select priority</option>
                    <option *ngFor="let option of (priorityOptions || [])" [value]="option.value">{{ option.label }}
                    </option>
                  </select>
                  <div *ngIf="priority?.invalid && priority?.touched" class="invalid-feedback">
                    <div *ngIf="priority?.errors?.['required']">Priority is required.</div>
                  </div>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="isUrgent" formControlName="isUrgent">
                    <label class="form-check-label" for="isUrgent">
                      <i class="bi bi-exclamation-triangle me-1"></i>
                      Mark as Urgent
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Status and Dates Section -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="status" class="form-label">Status <span class="text-danger">*</span></label>
              <select id="status" class="form-select" formControlName="status"
                [class.is-invalid]="status?.invalid && status?.touched">
                <option value="">Select status</option>
                <option *ngFor="let option of statusOptions" [value]="option.value">{{ option.label }}</option>
              </select>
              <div *ngIf="status?.invalid && status?.touched" class="invalid-feedback">
                <div *ngIf="status?.errors?.['required']">Status is required.</div>
              </div>
            </div>
            <div class="col-md-6">
              <label for="taskType" class="form-label">Task Type</label>
              <select id="taskType" class="form-select" formControlName="taskType">
                <option value="General">General</option>
                <option *ngFor="let option of (taskTypeOptions || [])" [value]="option.value">{{ option.label }}
                </option>
              </select>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="taskDate" class="form-label">Task Date <span class="text-danger">*</span></label>
              <input type="date" id="taskDate" class="form-control" formControlName="taskDate"
                [class.is-invalid]="taskDate?.invalid && taskDate?.touched">
              <div *ngIf="taskDate?.invalid && taskDate?.touched" class="invalid-feedback">
                <div *ngIf="taskDate?.errors?.['required']">Task date is required.</div>
              </div>
            </div>
            <div class="col-md-6">
              <label for="deadline" class="form-label">Deadline <span class="text-danger">*</span></label>
              <input type="date" id="deadline" class="form-control" formControlName="deadline"
                [class.is-invalid]="deadline?.invalid && deadline?.touched">
              <div *ngIf="deadline?.invalid && deadline?.touched" class="invalid-feedback">
                <div *ngIf="deadline?.errors?.['required']">Deadline is required.</div>
              </div>
            </div>
          </div>

          <!-- Location Details Section -->
          <div
            style="margin: 30px 0; padding: 30px; background: #f8f9fa; border-radius: 12px; border: 1px solid #e0e0e0;">

            <!-- Header -->
            <div
              style="display: flex; align-items: center; gap: 12px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #ddd;">
              <i class="fas fa-map-marked-alt" style="font-size: 1.5rem; color: #5b7cff;"></i>
              <h3 style="margin: 0; color: #5b7cff; font-size: 1.3rem; font-weight: 600;">Location Details</h3>
            </div>

            <!-- Manual Toggle -->
            <div style="margin-bottom: 25px;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.95rem;">
                <input type="checkbox" [checked]="manualLocationEntry" (change)="onManualToggle()"
                  style="width: 18px; height: 18px; cursor: pointer;" />
                <span>Location not found? Add Manually</span>
              </label>
            </div>

            <!-- Dropdowns Grid -->
            <div *ngIf="!manualLocationEntry" style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">

              <!-- State -->
              <div>
                <label
                  style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: #333;">
                  <i class="fas fa-map-marker-alt"></i>
                  State
                  <span style="color: red;">*</span>
                </label>
                <select formControlName="stateId" (change)="onStateChange($any($event.target).value)"
                  style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95rem; background: white;">
                  <option value="">Select State</option>
                  <option *ngFor="let state of states" [value]="state.id">{{ state.name }}</option>
                </select>
              </div>

              <!-- City -->
              <div>
                <label
                  style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: #333;">
                  <i class="fas fa-city"></i>
                  City
                  <span style="color: red;">*</span>
                </label>
                <select formControlName="cityId" (change)="onCityChange($any($event.target).value)"
                  style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95rem; background: white;">
                  <option value="">{{ !stateId?.value ? 'Select state first' : 'Select City' }}</option>
                  <option *ngFor="let city of cities" [value]="city.id">{{ city.name }}</option>
                </select>
              </div>

              <!-- Locality -->
              <div>
                <label
                  style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: #333;">
                  <i class="fas fa-search-location"></i>
                  Locality
                </label>
                <select formControlName="localityName" (change)="onLocalityChange($any($event.target).value)"
                  style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95rem; background: white;">
                  <option value="">Select Locality</option>
                  <option *ngFor="let locality of localitySuggestions" [value]="locality">{{ locality }}</option>
                </select>
              </div>

              <!-- Pincode -->
              <div>
                <label
                  style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: #333;">
                  <i class="fas fa-envelope-open-text"></i>
                  Pincode
                </label>
                <select formControlName="pincode"
                  style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95rem; background: white;">
                  <option value="">Auto-populated on Locality selection</option>
                  <option *ngFor="let pincode of pincodeOptions" [value]="pincode">{{ pincode }}</option>
                </select>
              </div>
            </div>

            <!-- Manual Entry Fields -->
            <div *ngIf="manualLocationEntry"
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; background: #fff9e6; border-radius: 8px; border: 2px solid #ffd966;">
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                  <i class="fas fa-map-marker-alt"></i> State *
                </label>
                <input type="text" placeholder="Type State Name" formControlName="stateName"
                  style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95rem;" />
              </div>
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                  <i class="fas fa-city"></i> City *
                </label>
                <input type="text" placeholder="Type City Name" formControlName="cityName"
                  style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95rem;" />
              </div>
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                  <i class="fas fa-search-location"></i> Locality
                </label>
                <input type="text" placeholder="Type Locality" formControlName="localityNameInput"
                  style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95rem;" />
              </div>
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                  <i class="fas fa-envelope-open-text"></i> Pincode
                </label>
                <input type="text" placeholder="Type Pincode" maxlength="10" formControlName="pincodeManual"
                  style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95rem;" />
              </div>
            </div>

            <!-- Selected Location Summary -->
            <div *ngIf="stateId?.value || cityId?.value || localityName?.value || pincode?.value || manualLocationEntry"
              style="margin-top: 25px; padding: 15px; background: #e8f4fd; border: 1px solid #b3d9f2; border-radius: 6px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                <i class="fas fa-info-circle" style="color: #1976d2;"></i>
                <strong style="color: #1976d2;">Selected Location</strong>
              </div>
              <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                <span *ngIf="stateId?.value || (manualLocationEntry && locationForm.value.stateName)"
                  style="display: inline-flex; align-items: center; gap: 6px; background: white; padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd;">
                  <i class="fas fa-map-marker-alt" style="color: #5b7cff;"></i>
                  {{ getStateName(stateId?.value) || locationForm.value.stateName }}
                </span>
                <span *ngIf="cityId?.value || (manualLocationEntry && locationForm.value.cityName)"
                  style="display: inline-flex; align-items: center; gap: 6px; background: white; padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd;">
                  <i class="fas fa-city" style="color: #5b7cff;"></i>
                  {{ getCityName(cityId?.value) || locationForm.value.cityName }}
                </span>
                <span *ngIf="localityName?.value || (manualLocationEntry && locationForm.value.localityNameInput)"
                  style="display: inline-flex; align-items: center; gap: 6px; background: white; padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd;">
                  <i class="fas fa-search-location" style="color: #5b7cff;"></i>
                  {{ localityName?.value || locationForm.value.localityNameInput }}
                </span>
                <span *ngIf="pincode?.value || (manualLocationEntry && locationForm.value.pincodeManual)"
                  style="display: inline-flex; align-items: center; gap: 6px; background: white; padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd;">
                  <i class="fas fa-envelope-open-text" style="color: #5b7cff;"></i>
                  {{ pincode?.value || locationForm.value.pincodeManual }}
                </span>
              </div>
            </div>

          </div>

          <!-- Additional Details Section -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="department" class="form-label">Department</label>
              <input type="text" id="department" class="form-control" formControlName="department"
                placeholder="e.g., Marketing">
            </div>
            <div class="col-md-6">
              <label for="taskCategory" class="form-label">Task Category</label>
              <select id="taskCategory" class="form-select" formControlName="taskCategory">
                <option *ngFor="let option of (categoryOptions || [])" [value]="option.value">{{ option.label }}
                </option>
              </select>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="clientName" class="form-label">Client Name</label>
              <input type="text" id="clientName" class="form-control" formControlName="clientName"
                placeholder="Enter client name">
            </div>
            <div class="col-md-6">
              <label for="projectCode" class="form-label">Project Code</label>
              <input type="text" id="projectCode" class="form-control" formControlName="projectCode"
                placeholder="Enter project code">
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="estimatedHours" class="form-label">Estimated Hours</label>
              <input type="number" id="estimatedHours" class="form-control" formControlName="estimatedHours" step="0.5"
                min="0" placeholder="e.g., 8.5">
            </div>
            <div class="col-md-6">
              <label for="actualHours" class="form-label">Actual Hours</label>
              <input type="number" id="actualHours" class="form-control" formControlName="actualHours" step="0.5"
                min="0" placeholder="e.g., 7.5">
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-12">
              <label for="additionalNotes" class="form-label">Additional Notes</label>
              <textarea id="additionalNotes" class="form-control" rows="2" formControlName="additionalNotes"
                placeholder="Any additional notes or instructions">
              </textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="onClose()" [disabled]="isSubmitting || isDeleting">
            Close
          </button>

          <button *ngIf="canDelete()" type="button" class="btn btn-danger" (click)="confirmDelete()"
            [disabled]="isSubmitting || isDeleting">
            <span *ngIf="isDeleting" class="spinner-border spinner-border-sm me-2"></span>
            Delete Task
          </button>

          <div *ngIf="showDeleteConfirm" class="alert alert-danger d-inline-block m-2 p-2">
            <strong>Confirm Delete?</strong> This action cannot be undone.
            <div class="mt-2">
              <button type="button" class="btn btn-outline-danger btn-sm me-2" (click)="deleteTask()">Yes,
                Delete</button>
              <button type="button" class="btn btn-outline-secondary btn-sm" (click)="cancelDelete()">Cancel</button>
            </div>
          </div>

          <button *ngIf="mode !== 'view'" type="submit" class="btn btn-primary" [disabled]="isSubmitting || isDeleting">
            <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
            {{ mode === 'create' ? 'Create Task' : 'Update Task' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>