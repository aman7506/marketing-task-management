<div class="employee-dashboard">

  <!-- Dashboard Header (Same as Admin) -->
  <div class="dashboard-header py-5 px-3"
    style="background: linear-gradient(90deg, #6366f1 0%, #0ea5e9 100%); border-radius: 1.5rem; box-shadow: 0 8px 32px rgba(0,0,0,0.11); margin-bottom:2.5rem;">
    <div class="container-fluid d-flex align-items-center justify-content-between flex-wrap">
      <div class="">
        <h1 class="display-4 fw-bold text-white mb-2"
          style="letter-spacing:-2px; text-shadow: 0 1px 18px rgba(0,0,0,0.12)">Employee Dashboard</h1>
        <p class="lead text-white opacity-75 mb-0">Welcome back, <span class="fw-bold text-white">{{ currentUser?.email
            }}</span>!<br>Manage and monitor all your tasks efficiently.</p>
      </div>
      <div class="d-flex flex-row gap-3">
        <button class="btn btn-dark btn-lg px-4 rounded-pill d-flex align-items-center shadow premium-btn"
          (click)="logout()"><i class="bi bi-box-arrow-right me-2"></i> Logout</button>
      </div>
    </div>
  </div>

  <!-- Task Statistics (Same as Admin) -->
  <div class="container-fluid py-4">
    <div class="stat-tiles-row d-flex flex-row flex-nowrap gap-4 justify-content-start align-items-end overflow-auto">
      <!-- Total Tasks -->
      <div
        class="stat-card stat-gradient-blue shadow rounded-4 text-white d-flex flex-column justify-content-center align-items-center px-4 py-3"
        style="min-width:148px; min-height:120px; border:none; cursor:pointer; transition: transform 0.2s, box-shadow 0.2s;"
        (click)="filterByStatus('all')">
        <div class="stat-number mb-1 fs-2 fw-bold" style="text-shadow:0 2px 10px rgba(0,0,0,0.11);">{{ tasks.length }}
        </div>
        <div class="fs-6 fw-semibold text-uppercase opacity-90">Total Tasks</div>
      </div>

      <!-- Not Started -->
      <div
        class="stat-card stat-gradient-purple shadow rounded-4 text-white d-flex flex-column justify-content-center align-items-center px-4 py-3"
        style="min-width:148px; min-height:120px; border:none; cursor:pointer; transition: transform 0.2s, box-shadow 0.2s;"
        (click)="filterByStatus('Not Started')">
        <div class="stat-number mb-1 fs-2 fw-bold" style="text-shadow:0 2px 10px rgba(0,0,0,0.11);">{{
          getStatusCount('Not Started') }}
        </div>
        <div class="fs-6 fw-semibold text-uppercase opacity-90">Not Started</div>
      </div>

      <!-- In Progress -->
      <div
        class="stat-card stat-gradient-teal shadow rounded-4 text-white link d-flex flex-column justify-content-center align-items-center px-4 py-3"
        style="min-width:148px; min-height:120px; border:none; cursor:pointer; transition: transform 0.2s, box-shadow 0.2s;"
        (click)="filterByStatus('In Progress')">
        <div class="stat-number mb-1 fs-2 fw-bold" style="text-shadow:0 2px 10px rgba(0,0,0,0.11);">{{
          getStatusCount('In Progress') }}
        </div>
        <div class="fs-6 fw-semibold text-uppercase opacity-90">In Progress</div>
      </div>

      <!-- Completed -->
      <div
        class="stat-card stat-gradient-yellow shadow rounded-4 text-white d-flex flex-column justify-content-center align-items-center px-4 py-3"
        style="min-width:148px; min-height:120px; border:none; cursor:pointer; transition: transform 0.2s, box-shadow 0.2s;"
        (click)="filterByStatus('Completed')">
        <div class="stat-number mb-1 fs-2 fw-bold" style="text-shadow:0 2px 10px rgba(0,0,0,0.11);">{{
          getStatusCount('Completed') }}
        </div>
        <div class="fs-6 fw-semibold text-uppercase opacity-90">Completed</div>
      </div>

      <!-- Partial Close -->
      <div
        class="stat-card stat-gradient-red shadow rounded-4 text-white d-flex flex-column justify-content-center align-items-center px-4 py-3"
        style="min-width:148px; min-height:120px; border:none; cursor:pointer; transition: transform 0.2s, box-shadow 0.2s;"
        (click)="filterByStatus('Partial Close')">
        <div class="stat-number mb-1 fs-2 fw-bold" style="text-shadow:0 2px 10px rgba(0,0,0,0.11);">{{
          getStatusCount('Partial Close') }}
        </div>
        <div class="fs-6 fw-semibold text-uppercase opacity-90">Partial Close</div>
      </div>

      <!-- Postponed -->
      <div
        class="stat-card stat-gradient-orange shadow rounded-4 text-white d-flex flex-column justify-content-center align-items-center px-4 py-3"
        style="min-width:148px; min-height:120px; border:none; cursor:pointer; transition: transform 0.2s, box-shadow 0.2s;"
        (click)="filterByStatus('Postponed')">
        <div class="stat-number mb-1 fs-2 fw-bold" style="text-shadow:0 2px 10px rgba(0,0,0,0.11);">{{
          getStatusCount('Postponed') }}
        </div>
        <div class="fs-6 fw-semibold text-uppercase opacity-90">Postponed</div>
      </div>
    </div>
  </div>

  <!-- Filter Controls (Clean like Admin) -->
  <div class="container-fluid pb-4 filter-controls">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-8">
            <label for="statusFilter" class="form-label fw-semibold">
              <i class="bi bi-funnel me-1"></i>Filter by Status
            </label>
            <select id="statusFilter" class="form-select" [(ngModel)]="selectedStatus"
              (change)="onStatusFilterChange()">
              <option *ngFor="let option of statusOptions" [value]="option.value">
                {{ option.label }}
              </option>
            </select>
          </div>
          <div class="col-md-4">
            <button class="btn btn-primary w-100" (click)="loadTasks()" [disabled]="isLoading">
              <span *ngIf="!isLoading">
                <i class="bi bi-arrow-clockwise me-2"></i>Refresh Data
              </span>
              <span *ngIf="isLoading">
                <span class="spinner-border spinner-border-sm me-2"></span>Loading...
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="container-fluid" *ngIf="isLoading">
    <div class="text-center py-5">
      <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
      <h4 class="text-muted">Loading tasks...</h4>
      <p class="text-muted">Please wait while we fetch the latest data</p>
    </div>
  </div>

  <!-- Task Cards -->
  <div class="container-fluid pt-3" *ngIf="!isLoading">
    <div class="row g-4">
      <div class="col-md-6 col-lg-4" *ngFor="let task of filteredTasks">
        <div class="task-card shadow">
          <div class="card-header">
            <h5 class="task-description-title mb-2">{{ task.description }}</h5>
            <div class="task-meta d-flex gap-2 flex-wrap">
              <small><i class="bi bi-hash"></i> #{{ task.taskId }}</small>
              <small><i class="bi bi-calendar3"></i> {{ formatDate(task.taskDate) }}</small>
            </div>
            <div class="task-badges mt-2">
              <span class="badge me-1" [ngClass]="getPriorityBadgeClass(task.priority)">{{ task.priority }}</span>
              <span class="badge" [ngClass]="getStatusBadgeClass(task.status)">{{ task.status }}</span>
            </div>
          </div>

          <div class="card-body">
            <div class="task-location mb-2">
              <i class="bi bi-geo-alt"></i>
              <strong>Location:</strong> {{ task.cityName }}{{ task.customLocation ? ' (' + task.customLocation + ')' :
              '' }}
            </div>
            <div class="task-deadline" [class.text-danger]="isOverdue(task.deadline) && task.status !== 'Completed'">
              <i class="bi bi-clock"></i>
              <strong>Deadline:</strong> {{ formatDate(task.deadline) }}
              <span class="badge bg-danger ms-2"
                *ngIf="isOverdue(task.deadline) && task.status !== 'Completed'">OVERDUE</span>
            </div>
          </div>

          <div class="card-footer">
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-sm btn-success" *ngIf="task.status === 'Not Started'"
                (click)="updateTaskStatus(task.taskId, 'In Progress')">
                <i class="bi bi-play-circle me-1"></i>Start
              </button>
              <button class="btn btn-sm btn-success" *ngIf="task.status === 'In Progress'"
                (click)="updateTaskStatus(task.taskId, 'Completed')">
                <i class="bi bi-check-circle me-1"></i>Complete
              </button>
              <button class="btn btn-sm btn-info" *ngIf="task.status === 'In Progress'"
                (click)="updateTaskStatus(task.taskId, 'Partial Close')">
                <i class="bi bi-dash-circle me-1"></i>Partial
              </button>
              <button class="btn btn-sm btn-warning" *ngIf="task.status === 'In Progress'"
                (click)="updateTaskStatus(task.taskId, 'Postponed')">
                <i class="bi bi-clock me-1"></i>Postpone
              </button>
              <button class="btn btn-sm btn-outline-primary" (click)="viewTaskDetails(task)">
                <i class="bi bi-eye me-1"></i>View
              </button>
              <button class="btn btn-sm btn-outline-success" (click)="openFeedbackModal(task)">
                <i class="bi bi-chat-dots me-1"></i>Feedback
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div class="col-12" *ngIf="filteredTasks.length === 0">
        <div class="text-center py-5">
          <i class="bi bi-clipboard-x" style="font-size: 3rem; color: #999;"></i>
          <h4 class="mt-3 text-muted">No Tasks Found</h4>
          <p class="text-muted" *ngIf="selectedStatus === 'all'">You don't have any assigned tasks yet.</p>
          <p class="text-muted" *ngIf="selectedStatus !== 'all'">No tasks with status "{{ selectedStatus }}".</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Task Details Modal -->
<div class="modal fade" [class.show]="showTaskDetails" [style.display]="showTaskDetails ? 'block' : 'none'"
  tabindex="-1" *ngIf="showTaskDetails" (click)="closeTaskDetails()">
  <div class="modal-dialog modal-lg modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content" *ngIf="selectedTask">
      <div class="modal-header bg-primary text-white">
        <h4 class="modal-title">
          <i class="bi bi-info-circle me-2"></i>Task Details
        </h4>
        <button type="button" class="btn-close btn-close-white" (click)="closeTaskDetails()"></button>
      </div>

      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <strong>Task ID:</strong> #{{ selectedTask.taskId }}
          </div>
          <div class="col-md-6">
            <strong>Priority:</strong>
            <span class="badge ms-1" [ngClass]="getPriorityBadgeClass(selectedTask.priority)">{{ selectedTask.priority
              }}</span>
          </div>
          <div class="col-md-6 mt-2">
            <strong>Status:</strong>
            <span class="badge ms-1" [ngClass]="getStatusBadgeClass(selectedTask.status)">{{ selectedTask.status
              }}</span>
          </div>
          <div class="col-12 mt-3">
            <strong>Description:</strong>
            <p>{{ selectedTask.description }}</p>
          </div>
          <div class="col-md-6">
            <strong>Location:</strong> {{ selectedTask.cityName }}
          </div>
          <div class="col-md-6">
            <strong>Task Date:</strong> {{ formatDate(selectedTask.taskDate) }}
          </div>
          <div class="col-md-6 mt-2">
            <strong>Deadline:</strong> {{ formatDate(selectedTask.deadline) }}
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeTaskDetails()">
          <i class="bi bi-x-circle me-2"></i>Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Feedback Modal -->
<div class="modal fade" [class.show]="showFeedbackModal" [style.display]="showFeedbackModal ? 'block' : 'none'"
  tabindex="-1" *ngIf="showFeedbackModal" (click)="closeFeedbackModal()">
  <div class="modal-dialog modal-lg modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content" *ngIf="selectedTask">
      <div class="modal-header bg-success text-white">
        <h4 class="modal-title">
          <i class="bi bi-chat-dots me-2"></i>Add Feedback
        </h4>
        <button type="button" class="btn-close btn-close-white" (click)="closeFeedbackModal()"></button>
      </div>

      <div class="modal-body">
        <h6 class="mb-3">Task: {{ selectedTask.description }}</h6>
        <p class="text-muted">Task ID: #{{ selectedTask.taskId }}</p>

        <form (ngSubmit)="submitFeedback()">
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Consultant Name</label>
              <input type="text" class="form-control" [(ngModel)]="feedbackForm.consultantName" name="consultantName"
                placeholder="Enter consultant name">
            </div>
            <div class="col-md-6">
              <label class="form-label">Meeting Date</label>
              <input type="date" class="form-control" [(ngModel)]="feedbackForm.meetingDate" name="meetingDate">
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Feedback *</label>
            <textarea class="form-control" [(ngModel)]="feedbackForm.feedbackText" name="feedbackText" rows="5"
              placeholder="Enter your feedback..." required></textarea>
          </div>

          <div class="mb-3" *ngIf="taskFeedbacks.length > 0">
            <h6 class="text-muted mb-3">Previous Feedbacks</h6>
            <div class="card mb-2" *ngFor="let feedback of taskFeedbacks">
              <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                  <strong>{{ feedback.consultantName || 'No name' }}</strong>
                  <small class="text-muted">{{ formatDate(feedback.createdAt) }}</small>
                </div>
                <p class="mb-0">{{ feedback.feedbackText }}</p>
              </div>
            </div>
          </div>

          <div class="d-flex gap-2 justify-content-end">
            <button type="button" class="btn btn-secondary" (click)="closeFeedbackModal()">
              <i class="bi bi-x-circle me-1"></i>Cancel
            </button>
            <button type="submit" class="btn btn-success" [disabled]="!feedbackForm.feedbackText.trim()">
              <i class="bi bi-check-circle me-1"></i>Submit
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop fade" [class.show]="showTaskDetails" *ngIf="showTaskDetails"></div>
<div class="modal-backdrop fade" [class.show]="showFeedbackModal" *ngIf="showFeedbackModal"></div>

<!-- Reschedule Modal -->
<app-task-reschedule-modal [task]="selectedTask" [show]="showRescheduleModal" (close)="closeRescheduleModal()"
  (taskRescheduled)="onTaskRescheduled($event)"></app-task-reschedule-modal>